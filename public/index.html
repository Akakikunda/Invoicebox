<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvoiceBox</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .auth-section { background: white; padding: 30px; border-radius: 8px; margin-bottom: 20px; }
        .dashboard { display: none; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #333; }
        .stat-label { color: #666; margin-top: 5px; }
        .invoices-table { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 50px auto; padding: 20px; border-radius: 8px; max-width: 500px;max-height: 80vh; /* Add this */
    overflow-y: auto; /* Add this */ }
        .nav { display: flex; gap: 20px; margin-bottom: 20px; }
        .nav-item { padding: 10px 20px; cursor: pointer; border-radius: 4px; }
        .nav-item.active { background: #007bff; color: white; }
        .status-pending { color: #ffc107; font-weight: bold; }
        .status-paid { color: #28a745; font-weight: bold; }
        .status-defaulted { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login/Register Section -->
        <div id="authSection" class="auth-section">
            <h2>InvoiceBox</h2>
            <div style="display: flex; gap: 20px; margin-top: 20px;">
                <div style="flex: 1;">
                    <h3>Login</h3>
                    <form id="loginForm">
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="loginEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Password:</label>
                            <input type="password" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                </div>
                <div style="flex: 1;">
                    <h3>Register</h3>
                    <form id="registerForm">
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="registerEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Password:</label>
                            <input type="password" id="registerPassword" required>
                        </div>
                        <div class="form-group">
                            <label>Role:</label>
                            <select id="registerRole" required>
                                <option value="provider">Provider</option>
                                <option value="purchaser">Purchaser</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Company Name:</label>
                            <input type="text" id="registerCompany" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Register</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Provider Dashboard -->
        <div id="providerDashboard" class="dashboard">
            <div class="header">
                <h2>Provider Dashboard - <span id="providerCompany"></span></h2>
                <button class="btn btn-primary" onclick="showCreateInvoiceModal()">Create Invoice</button>
                <button class="btn" onclick="logout()" style="float: right;">Logout</button>
            </div>

            <div class="stats-grid" id="providerStats"></div>

            <div class="nav">
                <div class="nav-item active" onclick="showTab('invoices')">Invoices</div>
                <div class="nav-item" onclick="showTab('analytics')">Analytics</div>
            </div>

            <div id="invoicesTab">
                <div class="invoices-table">
                    <table id="providerInvoicesTable">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Purchaser</th>
                                <th>Issue Date</th>
                                <th>Amount</th>
                                <th>Currency</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="providerInvoicesBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="analyticsTab" style="display: none;">
                <canvas id="providerChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Purchaser Dashboard -->
        <div id="purchaserDashboard" class="dashboard">
            <div class="header">
                <h2>Purchaser Dashboard - <span id="purchaserCompany"></span></h2>
                <button class="btn" onclick="logout()" style="float: right;">Logout</button>
            </div>

            <div class="stats-grid" id="purchaserStats"></div>

            <div class="nav">
                <div class="nav-item active" onclick="showTab('invoices')">Invoices</div>
                <div class="nav-item" onclick="showTab('payments')">Payments</div>
            </div>

            <div id="invoicesTab">
                <div class="invoices-table">
                    <table id="purchaserInvoicesTable">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Provider</th>
                                <th>Issue Date</th>
                                <th>Due Date</th>
                                <th>Amount</th>
                                <th>Currency</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="purchaserInvoicesBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="paymentsTab" style="display: none;">
                <div class="invoices-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Provider</th>
                                <th>Payment Date</th>
                                <th>Amount</th>
                                <th>Method</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Invoice Modal -->
    <div id="createInvoiceModal" class="modal">
        <div class="modal-content">
            <h3>Create New Invoice</h3>
            <form id="createInvoiceForm">
                <div class="form-group">
                    <label>Purchaser:</label>
                    <select id="invoicePurchaser" required>        <option value="">Select a purchaser...</option>
</select>
                </div>
                
                <div class="form-group">
                    <label>Currency:</label>
                    <select id="invoiceCurrency" required>
                        <option value="UGX">Uganda Shillings</option>
                        <option value="USD">US Dollars</option>
                        <option value="LYD">Libyan Dinar</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Due Date:</label>
                    <input type="date" id="invoiceDueDate" required>
                </div>
                <div id="invoiceItems">
                    <div class="invoice-item">
                        <div class="form-group">
                            <label>Item Description:</label>
                            <input type="text" class="item-description" required>
                        </div>
                        <div class="form-group">
                            <label>Quantity:</label>
                            <input type="number" class="item-quantity" required>
                        </div>
                        <div class="form-group">
                            <label>Unit Price:</label>
                            <input type="number" class="item-price" step="0.01" required>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="addInvoiceItem()">Add Item</button>
                <button type="submit" class="btn btn-success">Create Invoice</button>
                <button type="button" class="btn" onclick="document.getElementById('createInvoiceModal').style.display='none'">Cancel</button>
            </form>
        </div>
    </div>

    <script>
// Authentication state
let currentUser = null;
let token = localStorage.getItem('token');

// Check if user is already logged in
if (token) {
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        currentUser = payload;
        showDashboard();
    } catch (e) {
        localStorage.removeItem('token');
    }
}

// DOM Elements
const authSection = document.getElementById('authSection');
const providerDashboard = document.getElementById('providerDashboard');
const purchaserDashboard = document.getElementById('purchaserDashboard');

// Login Form
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;

    try {
        const response = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });

        const data = await response.json();
        
        if (response.ok) {
            token = data.token;
            currentUser = data.user;
            localStorage.setItem('token', token);
            showDashboard();
        } else {
            alert(data.error);
        }
    } catch (error) {
        alert('Login failed: ' + error.message);
    }
});

// Register Form
document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const role = document.getElementById('registerRole').value;
    const company_name = document.getElementById('registerCompany').value;

    try {
        const response = await fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, role, company_name })
        });

        const data = await response.json();
        
        if (response.ok) {
            token = data.token;
            currentUser = data.user;
            localStorage.setItem('token', token);
            showDashboard();
        } else {
            alert(data.error);
        }
    } catch (error) {
        alert('Registration failed: ' + error.message);
    }
});

// Show appropriate dashboard
function showDashboard() {
    authSection.style.display = 'none';
    
    if (currentUser.role === 'provider') {
        providerDashboard.style.display = 'block';
        purchaserDashboard.style.display = 'none';
        document.getElementById('providerCompany').textContent = currentUser.company_name;
        loadProviderData();
    } else {
        purchaserDashboard.style.display = 'block';
        providerDashboard.style.display = 'none';
        document.getElementById('purchaserCompany').textContent = currentUser.company_name;
        loadPurchaserData();
    }
}

// Load provider data
async function loadProviderData() {
    try {
        const [statsResponse, invoicesResponse] = await Promise.all([
            fetch('/api/dashboard/stats', {
                headers: { 'Authorization': `Bearer ${token}` }
            }),
            fetch('/api/invoices', {
                headers: { 'Authorization': `Bearer ${token}` }
            })
        ]);

        if (statsResponse.ok && invoicesResponse.ok) {
            const stats = await statsResponse.json();
            const invoices = await invoicesResponse.json();
            
            updateProviderStats(stats);
            displayProviderInvoices(invoices);
        }
    } catch (error) {
        console.error('Failed to load provider data:', error);
    }
}

// Load purchaser data
async function loadPurchaserData() {
    try {
        const [statsResponse, invoicesResponse] = await Promise.all([
            fetch('/api/dashboard/stats', {
                headers: { 'Authorization': `Bearer ${token}` }
            }),
            fetch('/api/invoices', {
                headers: { 'Authorization': `Bearer ${token}` }
            })
        ]);

        if (statsResponse.ok && invoicesResponse.ok) {
            const stats = await statsResponse.json();
            const invoices = await invoicesResponse.json();
            
            updatePurchaserStats(stats);
            displayPurchaserInvoices(invoices);
        }
    } catch (error) {
        console.error('Failed to load purchaser data:', error);
    }
}

// Update provider statistics
function updateProviderStats(stats) {
    const statsGrid = document.getElementById('providerStats');
    statsGrid.innerHTML = `
        <div class="stat-card">
            <div class="stat-value">${stats.total_invoices}</div>
            <div class="stat-label">Total Invoices</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${formatCurrency(stats.total_amount)}</div>
            <div class="stat-label">Total Value</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${formatCurrency(stats.pending_amount)}</div>
            <div class="stat-label">Pending Amount</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${formatCurrency(stats.paid_amount)}</div>
            <div class="stat-label">Paid Amount</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${formatCurrency(stats.defaulted_amount)}</div>
            <div class="stat-label">Defaulted Amount</div>
        </div>
    `;
}

// Update purchaser statistics
function updatePurchaserStats(stats) {
    const statsGrid = document.getElementById('purchaserStats');
    statsGrid.innerHTML = `
        <div class="stat-card">
            <div class="stat-value">${stats.total_invoices}</div>
            <div class="stat-label">Invoices Received</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${formatCurrency(stats.total_amount)}</div>
            <div class="stat-label">Total Owed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${formatCurrency(stats.pending_amount)}</div>
            <div class="stat-label">Pending Amount</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${formatCurrency(stats.paid_amount)}</div>
            <div class="stat-label">Paid Amount</div>
        </div>
    `;
}

// Display provider invoices
function displayProviderInvoices(invoices) {
    const tbody = document.getElementById('providerInvoicesBody');
    tbody.innerHTML = invoices.map(invoice => `
        <tr>
            <td>${invoice.invoice_number}</td>
            <td>${invoice.purchaser_company}</td>
            <td>${new Date(invoice.issue_date).toLocaleDateString()}</td>
            <td>${formatCurrency(invoice.total_amount)}</td>
            <td>${invoice.currency}</td>
            <td><span class="status-${invoice.status}">${invoice.status.toUpperCase()}</span></td>
            <td>
                <button class="btn btn-primary" onclick="viewInvoice(${invoice.id})">View</button>
            </td>
        </tr>
    `).join('');
}

// Display purchaser invoices
function displayPurchaserInvoices(invoices) {
    const tbody = document.getElementById('purchaserInvoicesBody');
    tbody.innerHTML = invoices.map(invoice => `
        <tr>
            <td>${invoice.invoice_number}</td>
            <td>${invoice.provider_company}</td>
            <td>${new Date(invoice.issue_date).toLocaleDateString()}</td>
            <td>${new Date(invoice.due_date).toLocaleDateString()}</td>
            <td>${formatCurrency(invoice.total_amount)}</td>
            <td>${invoice.currency}</td>
            <td><span class="status-${invoice.status}">${invoice.status.toUpperCase()}</span></td>
            <td>
                ${invoice.status === 'pending' ? `
                    <button class="btn btn-success" onclick="recordPayment(${invoice.id})">Pay</button>
                    <button class="btn btn-danger" onclick="markDefaulted(${invoice.id})">Default</button>
                ` : `
                    <button class="btn btn-primary" onclick="viewInvoice(${invoice.id})">View</button>
                `}
            </td>
        </tr>
    `).join('');
}

// Format currency
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(amount || 0);
}

// Show create invoice modal
async function showCreateInvoiceModal() {
    // Load purchasers for dropdown
    try {
        const response = await fetch('/api/users/purchasers', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const purchasers = await response.json();
        
        const select = document.getElementById('invoicePurchaser');
        select.innerHTML = purchasers.map(p => 
            `<option value="${p.id}">${p.company_name}</option>`
        ).join('');
    } catch (error) {
        console.error('Failed to load purchasers:', error);
    }
    
    document.getElementById('createInvoiceModal').style.display = 'block';
}

// Show create invoice modal
/*async function showCreateInvoiceModal() {
    // Load purchasers for dropdown
    try {
        const response = await fetch('/api/users/purchasers', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load purchasers');
        }
        
        const purchasers = await response.json();
        
        const select = document.getElementById('invoicePurchaser');
        select.innerHTML = '<option value="">Select a purchaser...</option>' + 
            purchasers.map(p => `<option value="${p.id}">${p.company_name}</option>`).join('');
        
        // Set default due date to 30 days from now
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 30);
        document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];
        
    } catch (error) {
        console.error('Failed to load purchasers:', error);
        alert('Failed to load purchaser list. Please try again.');
        return;
    }
    
    document.getElementById('createInvoiceModal').style.display = 'block';
}*/







// Add invoice item
function addInvoiceItem() {
    const itemsContainer = document.getElementById('invoiceItems');
    const newItem = document.createElement('div');
    newItem.className = 'invoice-item';
    newItem.innerHTML = `
        <div class="form-group">
            <label>Item Description:</label>
            <input type="text" class="item-description" required>
        </div>
        <div class="form-group">
            <label>Quantity:</label>
            <input type="number" class="item-quantity" required>
        </div>
        <div class="form-group">
            <label>Unit Price:</label>
            <input type="number" class="item-price" step="0.01" required>
        </div>
        <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">Remove</button>
    `;
    itemsContainer.appendChild(newItem);
}

// Create invoice form
document.getElementById('createInvoiceForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const purchaserId = document.getElementById('invoicePurchaser').value;
    const currency = document.getElementById('invoiceCurrency').value;
    const dueDate = document.getElementById('invoiceDueDate').value;
    
    const items = [];
    document.querySelectorAll('.invoice-item').forEach(item => {
        const description = item.querySelector('.item-description').value;
        const quantity = parseInt(item.querySelector('.item-quantity').value);
        const unitPrice = parseFloat(item.querySelector('.item-price').value);
        
        items.push({ description, quantity, unit_price: unitPrice });
    });
    
    try {
        const response = await fetch('/api/invoices', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                purchaser_id: purchaserId,
                currency: currency,
                due_date: dueDate,
                items: items
            })
        });

        if (response.ok) {
            alert('Invoice created successfully!');
            document.getElementById('createInvoiceModal').style.display = 'none';
            loadProviderData();
        } else {
            const data = await response.json();
            alert('Failed to create invoice: ' + data.error);
        }
    } catch (error) {
        alert('Failed to create invoice: ' + error.message);
    }
});

// Record payment
async function recordPayment(invoiceId) {
    const amount = prompt('Enter payment amount:');
    if (!amount) return;
    
    try {
        const response = await fetch(`/api/invoices/${invoiceId}/payments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                amount: parseFloat(amount),
                payment_date: new Date().toISOString().split('T')[0],
                payment_method: 'Bank Transfer'
            })
        });

        if (response.ok) {
            alert('Payment recorded successfully!');
            loadPurchaserData();
        } else {
            const data = await response.json();
            alert('Failed to record payment: ' + data.error);
        }
    } catch (error) {
        alert('Failed to record payment: ' + error.message);
    }
}

// Mark invoice as defaulted
async function markDefaulted(invoiceId) {
    if (!confirm('Are you sure you want to mark this invoice as defaulted?')) return;
    
    try {
        const response = await fetch(`/api/invoices/${invoiceId}/default`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            alert('Invoice marked as defaulted!');
            loadPurchaserData();
        } else {
            const data = await response.json();
            alert('Failed to mark as defaulted: ' + data.error);
        }
    } catch (error) {
        alert('Failed to mark as defaulted: ' + error.message);
    }
}

// View invoice details
function viewInvoice(invoiceId) {
    alert(`Viewing invoice ${invoiceId} - Details would show here in a real implementation`);
}

// Tab navigation
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('[id$="Tab"]').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // Show selected tab
    document.getElementById(tabName + 'Tab').style.display = 'block';
    
    // Update active nav
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.classList.add('active');
}

// Logout
function logout() {
    localStorage.removeItem('token');
    currentUser = null;
    token = null;
    
    providerDashboard.style.display = 'none';
    purchaserDashboard.style.display = 'none';
    authSection.style.display = 'block';
}
    </script>
</body>
</html>