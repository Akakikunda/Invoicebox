<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvoiceBox</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .auth-section { background: white; padding: 30px; border-radius: 8px; margin-bottom: 20px; }
        .dashboard { display: none; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #333; }
        .stat-label { color: #666; margin-top: 5px; }
        .invoices-table { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 50px auto; padding: 20px; border-radius: 8px; max-width: 500px;max-height: 80vh; /* Add this */
    overflow-y: auto; /* Add this */ }
        .nav { display: flex; gap: 20px; margin-bottom: 20px; }
        .nav-item { padding: 10px 20px; cursor: pointer; border-radius: 4px; }
        .nav-item.active { background: #007bff; color: white; }
        .status-pending { color: #ffc107; font-weight: bold; }
        .status-paid { color: #28a745; font-weight: bold; }
        .status-defaulted { color: #dc3545; font-weight: bold; }
        .payment-modal .modal-content { max-width: 400px; }

        /* Auth Tab Styles */
.auth-tab {
    flex: 1;
    padding: 15px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    font-size: 16px;
    color: #666;
    cursor: pointer;
    transition: all 0.3s ease;
}

.auth-tab.active {
    color: #007bff;
    border-bottom-color: #007bff;
    font-weight: 600;
}

.auth-tab:hover {
    color: #007bff;
    background: #f8f9fa;
}

/* Auth Section Updates */
.auth-section {
    background: white;
    padding: 60px 30px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    max-width: 480px;
    margin: 40px auto;
}

.form-group {
    margin-bottom: 20px;
}

.auth-btn {
    transition: all 0.3s ease;
}

.auth-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.auth-btn.primary:hover {
    background: #0056b3 !important;
}


/* Sidebar Layout */
.app-layout {
    display: flex;
    min-height: 100vh;
}

/*.sidebar {
    width: 250px;
    background: #f8f9fa;
    border-right: 1px solid #e0e0e0;
    padding: 20px 0;
}*/
.sidebar {
    width: 250px;
    background: #1a1f36; /* Dark blue background */
    border-right: 1px solid #2d3748;
    padding: 20px 0;
    color: white;
}


.sidebar-header {
    padding: 0 20px 20px 20px;
    /*border-bottom: 1px solid #e0e0e0;*/
    margin-bottom: 20px;
    border-bottom: 1px solid #2d3748;
}

.sidebar-header h3 {
    margin: 0 0 5px 0;
    color: white;  
    /*color: #333;*/

}
.sidebar-header p {
    color: #a0aec0;
    font-size: 12px;
    margin: 0;
}

.sidebar-nav {
    padding: 0 10px;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    color: #e2e8f0;
    text-decoration: none;
    border-radius: 6px;
    margin-bottom: 5px;
    transition: all 0.3s ease;
}


.nav-link:hover {
   /* background: #e9ecef;
    color: #007bff;*/
    background: #2d3748;
    color: white;
}


.nav-link.active {
    background: #007bff;
    color: white;
}

.nav-link span {
    margin-right: 10px;
    font-size: 16px;
}

.nav-divider {
    height: 1px;
    /*background: #e0e0e0;*/
    margin: 15px 0;
    background: #2d3748;
}


.logout-link {
    color: #dc3545 !important;
}


.logout-link:hover {
    background: #f8d7da !important;
}

.main-content {
    flex: 1;
    background: white;
    padding: 0;
}

.content-section {
    display: none;
    padding: 30px;
}

.content-section.active {
    display: block;
}

.content-header {
    /*display: flex;*/
    display: block; /* Change from flex to block */
    justify-content: between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e0e0e0;
}


/*.content-header h2 {
    margin: 0;
    color: #333;
}*/
.content-header h2 {
    margin: 0 0 10px 0; /* Add space below the heading */
    color: #333;
    font-size: 24px;
}

/*.content-header p {
    margin: 5px 0 0 0;
    color: #666;
}*/
.content-header p {
    margin: 0;
    color: #666;
    font-size: 16px;
}


    </style>
</head>
<body>
    <div class="container">
        <!-- Login/Register Section -->

        <!-- Login/Register Section -->
<div id="authSection" class="auth-section">
    <div style="max-width: 400px; margin: 0 auto; text-align: center;">
        <!-- Header -->
        <div style="margin-bottom: 40px;">
            <h1 style="color: #333; font-size: 32px; margin-bottom: 10px;">InvoiceBox</h1>
            <p style="color: #666; font-size: 16px;">Track invoices and payments</p>
        </div>

        <!-- Tabs -->
        <div style="display: flex; margin-bottom: 30px; border-bottom: 1px solid #e0e0e0;">
            <button id="loginTabBtn" class="auth-tab active" onclick="showAuthTab('login')">Sign In</button>
            <button id="registerTabBtn" class="auth-tab" onclick="showAuthTab('register')">Get Started</button>
        </div>

        <!-- Login Form -->
        <!--<div id="loginFormContainer">
            <form id="loginForm" style="text-align: left;">
                <div class="form-group">
                    <label style="color: #333; font-weight: 500; margin-bottom: 8px;">Email</label>
                    <input type="email" id="loginEmail" required style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 16px;">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                        <label style="color: #333; font-weight: 500;">Password</label>
                        <a href="#" style="color: #666; text-decoration: none; font-size: 14px;">Forgot password?</a>
                    </div>
                    <input type="password" id="loginPassword" required style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 16px;">
                </div>
                <button type="submit" class="auth-btn primary" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin-bottom: 20px;">
                    Sign In
                </button>
            </form>
        </div>-->
        <!-- Login Form -->
<div id="loginFormContainer">
    <form id="loginForm" style="text-align: left;">
        <div class="form-group">
            <label style="color: #333; font-weight: 500; margin-bottom: 8px;">Email</label>
            <input type="email" id="loginEmail" required style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 16px;">
        </div>
        <div class="form-group">
            <label style="color: #333; font-weight: 500; margin-bottom: 8px;">Password</label>
            <input type="password" id="loginPassword" required style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 16px;">
        </div>
        <div style="text-align: right; margin-bottom: 20px;">
            <a href="#" style="color: #666; text-decoration: none; font-size: 14px;">Forgot password?</a>
        </div>
        <button type="submit" class="auth-btn primary" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;">
            Sign In
        </button>
    </form>
</div>

        <!-- Register Form -->
        <div id="registerFormContainer" style="display: none;">
            <form id="registerForm" style="text-align: left;">
                <div class="form-group">
                    <label style="color: #333; font-weight: 500; margin-bottom: 8px;">Email</label>
                    <input type="email" id="registerEmail" required style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 16px;">
                </div>
                <div class="form-group">
                    <label style="color: #333; font-weight: 500; margin-bottom: 8px;">Password</label>
                    <input type="password" id="registerPassword" required style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 16px;">
                </div>
                <div class="form-group">
                    <label style="color: #333; font-weight: 500; margin-bottom: 8px;">Role</label>
                    <select id="registerRole" required style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 16px; background: white;">
                        <option value="provider">Provider</option>
                        <option value="purchaser">Purchaser</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="color: #333; font-weight: 500; margin-bottom: 8px;">Company Name</label>
                    <input type="text" id="registerCompany" required style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 16px;">
                </div>
                <button type="submit" class="auth-btn primary" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;">
                    Create Account
                </button>
            </form>
        </div>

        <!-- Divider -->
        <!--<div style="margin: 30px 0; text-align: center; position: relative;">
            <div style="height: 1px; background: #e0e0e0;"></div>
            <span style="background: white; padding: 0 15px; position: absolute; top: -10px; color: #666;">Or continue with</span>
        </div>-->

        <!-- Social Login Placeholder -->
        <!--<div style="text-align: center;">
            <p style="color: #666; margin-bottom: 20px;">Social login options coming soon</p>
        </div>-->
    </div>
</div>
        <!--<div id="authSection" class="auth-section">
            <h2>InvoiceBox</h2>
            <div style="display: flex; gap: 20px; margin-top: 20px;">
                <div style="flex: 1;">
                    <h3>Login</h3>
                    <form id="loginForm">
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="loginEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Password:</label>
                            <input type="password" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                </div>
                <div style="flex: 1;">
                    <h3>Register</h3>
                    <form id="registerForm">
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="registerEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Password:</label>
                            <input type="password" id="registerPassword" required>
                        </div>
                        <div class="form-group">
                            <label>Role:</label>
                            <select id="registerRole" required>
                                <option value="provider">Provider</option>
                                <option value="purchaser">Purchaser</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Company Name:</label>
                            <input type="text" id="registerCompany" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Register</button>
                    </form>
                </div>
            </div>
        </div>-->

        <!-- Provider Dashboard -->
        <!--<div id="providerDashboard" class="dashboard">
            <div class="header">
                <h2>Provider Dashboard - <span id="providerCompany"></span></h2>
                <button class="btn btn-primary" onclick="showCreateInvoiceModal()">Create Invoice</button>
                <button class="btn" onclick="logout()" style="float: right;">Logout</button>
            </div>

            <div class="stats-grid" id="providerStats"></div>

            <div class="nav">
                <div class="nav-item active" onclick="showTab('invoices')">Invoices</div>
                <div class="nav-item" onclick="showTab('analytics')">Analytics</div>
            </div>

            <div id="invoicesTab">
                <div class="invoices-table">
                    <table id="providerInvoicesTable">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Purchaser</th>
                                <th>Issue Date</th>
                                <th>Amount</th>
                                <th>Currency</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="providerInvoicesBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="analyticsTab" style="display: none;">
    <div style="text-align: center; margin-bottom: 20px;">
        <h3>Analytics Dashboard</h3>
    </div>
    
    <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
        <-- Charts will be inserted here dynamically -->
    <!--</div>
    
    !-- Add a loading message -->
    <!--<div id="analyticsLoading" style="text-align: center; padding: 40px;">
        <p>Loading analytics data...</p>
    </div>
</div>
        </div>

        <-- Purchaser Dashboard -->
        <!--<div id="purchaserDashboard" class="dashboard">
            <div class="header">
                <h2>Purchaser Dashboard - <span id="purchaserCompany"></span></h2>
                <button class="btn" onclick="logout()" style="float: right;">Logout</button>
            </div>

            <div class="stats-grid" id="purchaserStats"></div>

            <div class="nav">
            <--<div class="nav-item active" onclick="showTab('invoices')">Invoices</div>
                <div class="nav-item" onclick="showTab('payments')">Payments</div>--->
               <!--- <div class="nav-item active" onclick="showTab('invoices', event)">Invoices</div>
                <div class="nav-item" onclick="showTab('payments', event)">Payments</div>
            </div>

            <div id="invoicesTab">
                <div class="invoices-table">
                    <table id="purchaserInvoicesTable">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Provider</th>
                                <th>Issue Date</th>
                                <th>Due Date</th>
                                <th>Amount</th>
                                <th>Currency</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="purchaserInvoicesBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="paymentsTab" style="display: none;">
                <div class="invoices-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Provider</th>
                                <th>Payment Date</th>
                                <th>Amount</th>
                                <th>Method</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>-->


<!-- Provider Dashboard -->
<div id="providerDashboard" class="dashboard">
    <div class="app-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>InvoiceBox</h3>
                <p style="color: #666; font-size: 12px; margin: 0;">Provider Dashboard</p>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-link active" onclick="showSection('dashboard', event)">
                    <span>📊</span> Dashboard
                </a>
                <a href="#" class="nav-link" onclick="showSection('invoices', event)">
                    <span>📋</span> Invoices
                </a>
                <a href="#" class="nav-link" onclick="showSection('analytics', event)">
                    <span>📈</span> Analytics
                </a>
                <div class="nav-divider"></div>
                <a href="#" class="nav-link logout-link" onclick="logout()">
                    <span>🚪</span> Logout
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboardSection" class="content-section active">
                <div class="content-header">
                    <h2>Dashboard</h2>
                    <p>   Welcome back, <span id="providerCompany"></span></p>
                </div>
                
                <div class="stats-grid" id="providerStats">
                    <!-- Your existing stats will go here -->
                </div>
            </div>

            <!-- Invoices Section -->
            <div id="invoicesSection" class="content-section">
                <div class="content-header">
                    <h2>Invoices</h2>
                    <button class="btn btn-primary" onclick="showCreateInvoiceModal()">Create Invoice</button>
                </div>
                
                <div class="invoices-table">
                    <table id="providerInvoicesTable">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Purchaser</th>
                                <th>Issue Date</th>
                                <th>Amount</th>
                                <th>Currency</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="providerInvoicesBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analyticsSection" class="content-section">
                <div class="content-header">
                    <h2>Analytics</h2>
                </div>
                
                <!--<div id="analyticsContent">
                    <div style="text-align: center; padding: 40px;">
                        <p>Loading analytics data...</p>
                    </div>
                </div>-->
                <div id="analyticsContent">
    <div id="analyticsLoading" style="text-align: center; padding: 40px;">
        <p>Loading analytics data...</p>
    </div>
    <!-- Charts will be loaded here dynamically -->
</div>
            </div>
        </div>
    </div>
</div>

<!-- Purchaser Dashboard -->
<!--<div id="purchaserDashboard" class="dashboard">
    <div class="app-layout">
        !-- Sidebar -->
        <!--<div class="sidebar">
            <div class="sidebar-header">
                <h3>InvoiceBox</h3>
                <p style="color: #666; font-size: 12px; margin: 0;">Purchaser Dashboard</p>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-link active" onclick="showSection('dashboard', event)">
                    <span>📊</span> Dashboard
                </a>
                <a href="#" class="nav-link" onclick="showSection('invoices', event)">
                    <span>📋</span> Invoices
                </a>
                <a href="#" class="nav-link" onclick="showSection('payments', event)">
                    <span>💰</span> Payments
                </a>
                <div class="nav-divider"></div>
                <a href="#" class="nav-link logout-link" onclick="logout()">
                    <span>🚪</span> Logout
                </a>
            </nav>
        </div>

        !-- Main Content -->
        <!--<div class="main-content">
            !-- Dashboard Section -->
            <!--<div id="purchaserDashboardSection" class="content-section active">
                <div class="content-header">
                    <h2>Dashboard Overview</h2>
                    <p>Welcome back, <span id="purchaserCompany"></span></p>
                </div>
                
                <div class="stats-grid" id="purchaserStats">
                    <-- Your existing stats will go here -->
                <!--</div>
            </div>

            <-- Invoices Section -->
            <!--<div id="purchaserInvoicesSection" class="content-section">
                <div class="content-header">
                    <h2>Invoices</h2>
                </div>
                
                <div class="invoices-table">
                    <table id="purchaserInvoicesTable">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Provider</th>
                                <th>Issue Date</th>
                                <th>Due Date</th>
                                <th>Amount</th>
                                <th>Currency</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="purchaserInvoicesBody"></tbody>
                    </table>
                </div>
            </div>

            <-- Payments Section -->
            <!--<div id="paymentsSection" class="content-section">
                <div class="content-header">
                    <h2>Payment History</h2>
                </div>
                
                 !-- Add this temporary button -->
                 <!--<button class="btn btn-primary" onclick="testPayments()">Test Payments</button>
                 </div>


                <div class="invoices-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Provider</th>
                                <th>Payment Date</th>
                                <th>Amount</th>
                                <th>Method</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsBody"></tbody>
                    </table>
                </div>
            </div>-->

            <!-- Payments Section -->
<!--<div id="paymentsSection" class="content-section">
    <div class="content-header">
        <h2>Payment History</h2>
        <-- Add this temporary button -->
        <!--<button class="btn btn-primary" onclick="testPayments()">Test Payments</button>
    </div>

    <div class="invoices-table">
        <table>
            <thead>
                <tr>
                    <th>Invoice #</th>
                    <th>Provider</th>
                    <th>Payment Date</th>
                    <th>Amount</th>
                    <th>Method</th>
                </tr>
            </thead>
            <tbody id="paymentsBody"></tbody>
        </table>
    </div>
        </div>
    </div>
</div>-->

<!-- Purchaser Dashboard -->
<div id="purchaserDashboard" class="dashboard">
    <div class="app-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>InvoiceBox</h3>
                <p style="color: #666; font-size: 12px; margin: 0;">Purchaser Dashboard</p>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-link active" onclick="showSection('dashboard', event)">
                    <span>📊</span> Dashboard
                </a>
                <a href="#" class="nav-link" onclick="showSection('invoices', event)">
                    <span>📋</span> Invoices
                </a>
                <a href="#" class="nav-link" onclick="showSection('payments', event)">
                    <span>💰</span> Payments
                </a>
                <div class="nav-divider"></div>
                <a href="#" class="nav-link logout-link" onclick="logout()">
                    <span>🚪</span> Logout
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="purchaserDashboardSection" class="content-section active">
                <div class="content-header">
                    <h2>Dashboard </h2>
                   <p>   Welcome back, <span id="purchaserCompany"></span></p>
                </div>
                
                <div class="stats-grid" id="purchaserStats">
                    <!-- Your existing stats will go here -->
                </div>
            </div>

            <!-- Invoices Section -->
            <div id="purchaserInvoicesSection" class="content-section">
                <div class="content-header">
                    <h2>Invoices</h2>
                </div>
                
                <div class="invoices-table">
                    <table id="purchaserInvoicesTable">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Provider</th>
                                <th>Issue Date</th>
                                <th>Due Date</th>
                                <th>Amount</th>
                                <th>Currency</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="purchaserInvoicesBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Payments Section -->
            <!--<div id="paymentsSection" class="content-section">
                <div class="content-header">
                    <h2>Payment History</h2>
                    <-- Add this temporary button -->
                    <!--<button class="btn btn-primary" onclick="testPayments()">Test Payments</button>
                </div>
                
                <div class="invoices-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Provider</th>
                                <th>Payment Date</th>
                                <th>Amount</th>
                                <th>Method</th>
                            </tr>
                        </thead>
                        <tbody id="paymentsBody"></tbody>
                    </table>
                </div>
            </div>-->
            <!-- Payments Section -->
<div id="paymentsSection" class="content-section">
    <div class="content-header">
        <h2>Payment History</h2>
        <button class="btn btn-primary" onclick="testPayments()">Test Payments</button>
        <button class="btn btn-secondary" onclick="debugPayments()">Debug API</button>
        <button class="btn btn-secondary" onclick="debugPaymentsView()">Debug View</button>
    </div>
    
    <div class="invoices-table">
        <table>
            <thead>
                <tr>
                    <th>Invoice #</th>
                    <th>Provider</th>
                    <th>Payment Date</th>
                    <th>Amount</th>
                    <th>Method</th>
                </tr>
            </thead>
            <tbody id="paymentsBody">
                <!-- Payments will be loaded here -->
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                        Loading payments...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
        </div>
    </div>
</div>













    <!-- Create Invoice Modal -->
    <div id="createInvoiceModal" class="modal">
        <div class="modal-content">
            <h3>Create New Invoice</h3>
            <form id="createInvoiceForm">
                <div class="form-group">
                    <label>Purchaser:</label>
                    <select id="invoicePurchaser" required>        <option value="">Select a purchaser...</option>
</select>
                </div>
                
                <div class="form-group">
                    <label>Currency:</label>
                    <select id="invoiceCurrency" required>
                        <option value="UGX">Uganda Shillings</option>
                        <option value="USD">US Dollars</option>
                        <option value="LYD">Libyan Dinar</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Due Date:</label>
                    <input type="date" id="invoiceDueDate" required>
                </div>
                <div id="invoiceItems">
                    <div class="invoice-item">
                        <div class="form-group">
                            <label>Item Description:</label>
                            <input type="text" class="item-description" required>
                        </div>
                        <div class="form-group">
                            <label>Quantity:</label>
                            <input type="number" class="item-quantity" required>
                        </div>
                        <div class="form-group">
                            <label>Unit Price:</label>
                            <input type="number" class="item-price" step="0.01" required>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="addInvoiceItem()">Add Item</button>
                <button type="submit" class="btn btn-success">Create Invoice</button>
                <button type="button" class="btn" onclick="document.getElementById('createInvoiceModal').style.display='none'">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Payment Modal -->
<div id="paymentModal" class="modal payment-modal">
    <div class="modal-content">
        <h3>Record Payment</h3>
        <form id="paymentForm">
            <input type="hidden" id="paymentInvoiceId">
            <div class="form-group">
                <label>Amount:</label>
                <input type="number" id="paymentAmount" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Payment Date:</label>
                <input type="date" id="paymentDate" required>
            </div>
            <div class="form-group">
                <label>Payment Method:</label>
                <select id="paymentMethod" required>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="Cash">Cash</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="Mobile Money">Mobile Money</option>
                    <option value="Check">Check</option>
                </select>
            </div>
            <div class="form-group">
                <label>Reference Number (Optional):</label>
                <input type="text" id="paymentReference">
            </div>
            <button type="submit" class="btn btn-success">Record Payment</button>
            <button type="button" class="btn" onclick="document.getElementById('paymentModal').style.display='none'">Cancel</button>
        </form>
    </div>
</div>

    <script>
// Authentication state
/*let currentUser = null;
let token = localStorage.getItem('token');


// Enhanced token validation
function validateToken() {
    if (!token) return false;
    
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        // Check if token is expired (24 hours from issuance)
        const tokenAge = Date.now() - (payload.iat * 1000);
        const isExpired = tokenAge > (24 * 60 * 60 * 1000); // 24 hours
        
        if (!isExpired) {
            currentUser = payload;
            return true;
        }
    } catch (e) {
        console.error('Token validation error:', e);
    }
    
    // Clear invalid token
    localStorage.removeItem('token');
    token = null;
    currentUser = null;
    return false;
}*/

// Check if user is already logged in
/*if (validateToken()) {
    showDashboard();
}*/

// Authentication state
let currentUser = null;
let token = localStorage.getItem('token');

// Check if user is already logged in
if (token) {
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        currentUser = payload;
        showDashboard();
    } catch (e) {
        localStorage.removeItem('token');
    }
}


// Auth tab switching
function showAuthTab(tabName) {
    const loginTab = document.getElementById('loginFormContainer');
    const registerTab = document.getElementById('registerFormContainer');
    const loginBtn = document.getElementById('loginTabBtn');
    const registerBtn = document.getElementById('registerTabBtn');

    if (tabName === 'login') {
        loginTab.style.display = 'block';
        registerTab.style.display = 'none';
        loginBtn.classList.add('active');
        registerBtn.classList.remove('active');
    } else {
        loginTab.style.display = 'none';
        registerTab.style.display = 'block';
        loginBtn.classList.remove('active');
        registerBtn.classList.add('active');
    }
}

// Section navigation
/*function showSection(sectionName, event) {
    if (event) event.preventDefault();
    
    const userRole = currentUser.role;
    const prefix = userRole === 'provider' ? '' : 'purchaser';
    
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Show selected section
    const sectionId = userRole === 'provider' ? 
        `${sectionName}Section` : 
        `${prefix}${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)}Section`;
    
    document.getElementById(sectionId).classList.add('active');
    
    // Update active nav link
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    if (event) {
        event.target.classList.add('active');
    } else {
        // Find and activate the correct nav link
        document.querySelectorAll('.nav-link').forEach(link => {
            if (link.textContent.toLowerCase().includes(sectionName.toLowerCase())) {
                link.classList.add('active');
            }
        });
    }
    
    // Load data for the section
    /*if (sectionName === 'dashboard') {
        if (userRole === 'provider') {
            loadProviderData();
        } else {
            loadPurchaserData();
        }
    } else if (sectionName === 'analytics' && userRole === 'provider') {
        loadAnalytics();
    } else if (sectionName === 'payments' && userRole === 'purchaser') {
        loadPurchaserData(); // This will load payments too
    }*/
   /*if (sectionName === 'dashboard') {
        if (userRole === 'provider') {
            loadProviderData();
        } else {
            loadPurchaserData();
        }
    } else if (sectionName === 'analytics' && userRole === 'provider') {
        loadAnalytics();
    } else if (sectionName === 'payments' && userRole === 'purchaser') {
        // Make sure payments data is loaded
        loadPurchaserData();
    } else if (sectionName === 'invoices') {
        // Load invoices when invoices section is clicked
        if (userRole === 'provider') {
            loadProviderData();
        } else {
            loadPurchaserData();
        }
    } 
} */

// Section navigation
async function showSection(sectionName, event) {
    if (event) event.preventDefault();
    
    const userRole = currentUser.role;
    
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Show selected section
    let sectionId;
    if (userRole === 'provider') {
        sectionId = `${sectionName}Section`;
    } else {
        sectionId = `purchaser${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)}Section`;
    }
    
    const sectionElement = document.getElementById(sectionId);
    if (sectionElement) {
        sectionElement.classList.add('active');
    }
    
    // Update active nav link
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    
    if (event) {
        event.target.classList.add('active');
    }
    
    // Load data for the section
    if (userRole === 'provider') {
        if (sectionName === 'dashboard' || sectionName === 'invoices') {
            loadProviderData();
        } else if (sectionName === 'analytics') {
            loadAnalytics();
        }
    } 
    // In the showSection function, find the purchaser section and modify it:
      else {
    // Purchaser
       if (sectionName === 'dashboard' || sectionName === 'invoices' || sectionName === 'payments') {
        console.log('🔄 Loading purchaser data for section:', sectionName);
           await loadPurchaserData();
        
        // If specifically on payments section, force a refresh
        if (sectionName === 'payments') {
            setTimeout(() => {
                console.log('🔄 Specifically refreshing payments data');
                loadPurchaserData();
            }, 500);
        }
    }
}
}






// Check if user is already logged in
/*if (token) {
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        currentUser = payload;
        showDashboard();
    } catch (e) {
        localStorage.removeItem('token');
    }
}*/

/*if (token) {
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        // Check if token is expired (we use 24hr expiration)
        const isExpired = Date.now() >= payload.exp * 1000;
        if (!isExpired) {
            currentUser = payload;
            showDashboard();
        } else {
            localStorage.removeItem('token');
            token = null;
        }
    } catch (e) {
        localStorage.removeItem('token');
        token = null;
    }
}
*/

// Refresh token silently
async function refreshToken() {
    try {
        const response = await fetch('/api/refresh-token', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            token = data.token;
            localStorage.setItem('token', token);
            currentUser = JSON.parse(atob(token.split('.')[1]));
            console.log('Token refreshed successfully');
        }
    } catch (error) {
        console.log('Token refresh failed, continuing with current token');
    }
}

// Refresh token every 30 minutes
setInterval(refreshToken, 30 * 60 * 1000);




// Add automatic token refresh on API calls
async function apiCall(url, options = {}) {
    if (!options.headers) options.headers = {};
    options.headers['Authorization'] = `Bearer ${token}`;
    
    const response = await fetch(url, options);
    
    // If token is invalid, logout
    if (response.status === 401 || response.status === 403) {
        logout();
        throw new Error('Session expired. Please login again.');
    }
    
    return response;
}


// Enhanced API call function with better error handling
/*async function apiCall(url, options = {}) {
    if (!options.headers) options.headers = {};
    options.headers['Authorization'] = `Bearer ${token}`;
    
    try {
        const response = await fetch(url, options);
        
        
        if (response.status === 401) {
            // Token expired, try to refresh
            await refreshToken();
            // Retry with new token
            options.headers['Authorization'] = `Bearer ${token}`;
            const retryResponse = await fetch(url, options);
            return retryResponse;
        }
        
        return response;
    } catch (error) {
        console.error('API call failed:', error);
        throw error;
    }
}*/

// Test payments function - add this temporarily
async function testPayments() {
    try {
        console.log('Testing payments...');
        
        // Test 1: Check if API endpoint works
        const response = await fetch('/api/payments', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        console.log('Payments API status:', response.status);
        
        if (response.ok) {
            const payments = await response.json();
            console.log('Payments data:', payments);
            console.log('Number of payments:', payments.length);
            
            // Test 2: Check if table body exists
            const tbody = document.getElementById('paymentsBody');
            console.log('Payments table body found:', !!tbody);
            
            if (tbody) {
                console.log('Table body innerHTML before:', tbody.innerHTML);
                // Try to display the payments
                displayPayments(payments);
                console.log('Table body innerHTML after:', tbody.innerHTML);
            }
        } else {
            console.log('Payments API error:', await response.json());
        }
    } catch (error) {
        console.error('Payments test error:', error);
    }
}

// Add this debug function
async function debugPaymentsView() {
    console.log('=== PAYMENTS VIEW DEBUG ===');
    
    // Check if we're on payments section
    const paymentsSection = document.getElementById('paymentsSection');
    console.log('Payments section found:', !!paymentsSection);
    console.log('Payments section active:', paymentsSection?.classList.contains('active'));
    
    // Check table body
    const tbody = document.getElementById('paymentsBody');
    console.log('Payments table body found:', !!tbody);
    console.log('Current table body content:', tbody?.innerHTML);
    
    // Force reload payments data
    console.log('Forcing payments reload...');
    await loadPurchaserData();
    
    console.log('=== DEBUG COMPLETE ===');
}

// DOM Elements
const authSection = document.getElementById('authSection');
const providerDashboard = document.getElementById('providerDashboard');
const purchaserDashboard = document.getElementById('purchaserDashboard');

// Login Form
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;

    try {
        const response = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });

        const data = await response.json();
        
        if (response.ok) {
            token = data.token;
            currentUser = data.user;
            localStorage.setItem('token', token);
            showDashboard();
        } else {
            alert(data.error);
        }
    } catch (error) {
        alert('Login failed: ' + error.message);
    }
});

// Register Form
document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const role = document.getElementById('registerRole').value;
    const company_name = document.getElementById('registerCompany').value;

    try {
        const response = await fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, role, company_name })
        });

        const data = await response.json();
        
        if (response.ok) {
            token = data.token;
            currentUser = data.user;
            localStorage.setItem('token', token);
            showDashboard();
        } else {
            alert(data.error);
        }
    } catch (error) {
        alert('Registration failed: ' + error.message);
    }
});

// Show appropriate dashboard
/*function showDashboard() {
    authSection.style.display = 'none';
    
    if (currentUser.role === 'provider') {
        providerDashboard.style.display = 'block';
        purchaserDashboard.style.display = 'none';
        document.getElementById('providerCompany').textContent = currentUser.company_name;
        loadProviderData();
    } else {
        purchaserDashboard.style.display = 'block';
        providerDashboard.style.display = 'none';
        document.getElementById('purchaserCompany').textContent = currentUser.company_name;
        loadPurchaserData();
    }
}*/
// Show appropriate dashboard
/*function showDashboard() {
    authSection.style.display = 'none';
    
    if (currentUser.role === 'provider') {
        providerDashboard.style.display = 'block';
        purchaserDashboard.style.display = 'none';
        document.getElementById('providerCompany').textContent = currentUser.company_name;
        loadProviderData();
    } else {
        purchaserDashboard.style.display = 'block';
        providerDashboard.style.display = 'none';
        document.getElementById('purchaserCompany').textContent = currentUser.company_name;
        loadPurchaserData();
    }
}*/
// Show appropriate dashboard
function showDashboard() {
    authSection.style.display = 'none';
    
    if (currentUser.role === 'provider') {
        providerDashboard.style.display = 'block';
        purchaserDashboard.style.display = 'none';
        document.getElementById('providerCompany').textContent = currentUser.company_name;
        // Load initial data
        loadProviderData();
    } else {
        purchaserDashboard.style.display = 'block';
        providerDashboard.style.display = 'none';
        document.getElementById('purchaserCompany').textContent = currentUser.company_name;
        // Load initial data
        loadPurchaserData();
    }
}

// Load provider data
async function loadProviderData() {
    try {
        const [statsResponse, invoicesResponse] = await Promise.all([
            fetch('/api/dashboard/stats', {
                headers: { 'Authorization': `Bearer ${token}` }
            }),
            fetch('/api/invoices', {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            ]);
        

        

        if (statsResponse.ok && invoicesResponse.ok) {
            const stats = await statsResponse.json();
            const invoices = await invoicesResponse.json();
            
            updateProviderStats(stats);
            displayProviderInvoices(invoices);
        }
    } catch (error) {
        console.error('Failed to load provider data:', error);
    }
}

// Load purchaser data
/*async function loadPurchaserData() {
    try {
        const [statsResponse, invoicesResponse, paymentsResponse] = await Promise.all([
            fetch('/api/dashboard/stats', {
                headers: { 'Authorization': `Bearer ${token}` }
            }),
            fetch('/api/invoices', {
                headers: { 'Authorization': `Bearer ${token}` }
            }),
            fetch('/api/payments', {
                headers: { 'Authorization': `Bearer ${token}` }
            })
        ]);
    

        if (statsResponse.ok && invoicesResponse.ok) {
            const stats = await statsResponse.json();
            const invoices = await invoicesResponse.json();
            
            updatePurchaserStats(stats);
            displayPurchaserInvoices(invoices);
            
            // Load payments if response was ok
            if (paymentsResponse.ok) {
                const payments = await paymentsResponse.json();
                displayPayments(payments);
            }
        }
    } catch (error) {
        console.error('Failed to load purchaser data:', error);
    }
}*/
// Load purchaser data
/*async function loadPurchaserData() {
    try {
        const [statsResponse, invoicesResponse, paymentsResponse] = await Promise.all([
            fetch('/api/dashboard/stats', {
                headers: { 'Authorization': `Bearer ${token}` }
            }),
            fetch('/api/invoices', {
                headers: { 'Authorization': `Bearer ${token}` }
            }),
            fetch('/api/payments', {
                headers: { 'Authorization': `Bearer ${token}` }
            })
        ]);

        if (statsResponse.ok && invoicesResponse.ok) {
            const stats = await statsResponse.json();
            const invoices = await invoicesResponse.json();
            
            updatePurchaserStats(stats);
            displayPurchaserInvoices(invoices);
            
            // Always load payments, even if empty
            if (paymentsResponse.ok) {
                const payments = await paymentsResponse.json();
                displayPayments(payments);
            }
        }
    } catch (error) {
        console.error('Failed to load purchaser data:', error);
    }
}*/
// Load purchaser data - ENHANCED VERSION
async function loadPurchaserData() {
    try {
        console.log('Loading purchaser data...');
        
        const [statsResponse, invoicesResponse, paymentsResponse] = await Promise.all([
            fetch('/api/dashboard/stats', {
                headers: { 'Authorization': `Bearer ${token}` }
            }),
            fetch('/api/invoices', {
                headers: { 'Authorization': `Bearer ${token}` }
            }),
            fetch('/api/payments', {
                headers: { 'Authorization': `Bearer ${token}` }
            })
        ]);

        // Handle stats
        if (statsResponse.ok) {
            const stats = await statsResponse.json();
            updatePurchaserStats(stats);
        } else {
            console.error('Stats failed:', statsResponse.status);
        }

        // Handle invoices
        if (invoicesResponse.ok) {
            const invoices = await invoicesResponse.json();
            displayPurchaserInvoices(invoices);
        } else {
            console.error('Invoices failed:', invoicesResponse.status);
        }

        // Handle payments - ALWAYS process payments response
        console.log('Payments response status:', paymentsResponse.status);
        if (paymentsResponse.ok) {
            const payments = await paymentsResponse.json();
            console.log('Payments data received:', payments);
            displayPayments(payments);
        } else {
            console.error('Payments failed:', paymentsResponse.status);
            // Even if API fails, show empty state
            displayPayments([]);
        }
        
    } catch (error) {
        console.error('Failed to load purchaser data:', error);
        // Ensure payments table shows something even on error
        displayPayments([]);
    }
}



// Display payments in payments tab
/*function displayPayments(payments) {
    const tbody = document.getElementById('paymentsBody');
    tbody.innerHTML = payments.map(payment => `
        <tr>
            <td>${payment.invoice_number}</td>
            <td>${payment.provider_company}</td>
            <td>${new Date(payment.payment_date).toLocaleDateString()}</td>
            <td>${formatCurrency(payment.amount)}</td>
            <td>${payment.payment_method || 'Bank Transfer'}</td>
        </tr>
    `).join('');
}*/
// Display payments in payments section
// Display payments in payments section
/*function displayPayments(payments) {
    const tbody = document.getElementById('paymentsBody');
    if (!tbody) return;
    
    if (!payments || payments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #666;">No payments recorded yet</td></tr>';
    } else {
        tbody.innerHTML = payments.map(payment => `
            <tr>
                <td>${payment.invoice_number || 'N/A'}</td>
                <td>${payment.provider_company || 'N/A'}</td>
                <td>${new Date(payment.payment_date).toLocaleDateString()}</td>
                <td>${formatCurrency(payment.amount)}</td>
                <td>${payment.payment_method || 'Bank Transfer'}</td>
            </tr>
        `).join('');
    }
}*/

// Display payments in payments section - FIXED VERSION
/*f]unction displayPayments(payments) {
    console.log('Displaying payments:', payments);
    
    const tbody = document.getElementById('paymentsBody');
    if (!tbody) {
        console.error('Payments table body not found!');
        return;
    }
    
    if (!payments || payments.length === 0) {
        console.log('No payments data found');
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #666;">No payments recorded yet</td></tr>';
    } else {
        console.log(`Rendering ${payments.length} payments`);
        tbody.innerHTML = payments.map(payment => `
            <tr>
                <td>${payment.invoice_number || 'N/A'}</td>
                <td>${payment.provider_company || 'N/A'}</td>
                <td>${new Date(payment.payment_date).toLocaleDateString()}</td>
                <td>${formatCurrency(payment.amount)}</td>
                <td>${payment.payment_method || 'Bank Transfer'}</td>
            </tr>
        `).join('');
    }
}*/

// Display payments in payments section - AGGRESSIVE VERSION
function displayPayments(payments) {
    console.log('🔄 Displaying payments:', payments);
    
    const tbody = document.getElementById('paymentsBody');
    if (!tbody) {
        console.error('❌ Payments table body not found!');
        // Try to find it again after a delay
        setTimeout(() => {
            const retryTbody = document.getElementById('paymentsBody');
            if (retryTbody) {
                console.log('✅ Found table body on retry');
                displayPayments(payments);
            }
        }, 100);
        return;
    }
    
    if (!payments || payments.length === 0) {
        console.log('ℹ️ No payments data found');
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #666;">No payments recorded yet</td></tr>';
    } else {
        console.log(`✅ Rendering ${payments.length} payments`);
        
        const paymentsHTML = payments.map(payment => `
            <tr>
                <td>${payment.invoice_number || 'N/A'}</td>
                <td>${payment.provider_company || 'N/A'}</td>
                <td>${new Date(payment.payment_date).toLocaleDateString()}</td>
                <td>${formatCurrency(payment.amount)}</td>
                <td>${payment.payment_method || 'Bank Transfer'}</td>
            </tr>
        `).join('');
        
        tbody.innerHTML = paymentsHTML;
        
        // Verify the update
        console.log('📊 Table rows after update:', tbody.querySelectorAll('tr').length);
    }
}






// Load purchaser data
/*async function loadPurchaserData() {
    try {
        const [statsResponse, invoicesResponse] = await Promise.all([
            fetch('/api/dashboard/stats', {
                headers: { 'Authorization': `Bearer ${token}` }
            }),
            fetch('/api/invoices', {
                headers: { 'Authorization': `Bearer ${token}` }
            })
        ]);

        if (statsResponse.ok && invoicesResponse.ok) {
            const stats = await statsResponse.json();
            const invoices = await invoicesResponse.json();
            
            updatePurchaserStats(stats);
            displayPurchaserInvoices(invoices);
        }
    } catch (error) {
        console.error('Failed to load purchaser data:', error);
    }
}*/

// Update provider statistics
function updateProviderStats(stats) {
    const statsGrid = document.getElementById('providerStats');
    statsGrid.innerHTML = `
        <div class="stat-card">
            <div class="stat-value">${stats.total_invoices}</div>
            <div class="stat-label">Total Invoices</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${formatCurrency(stats.total_amount)}</div>
            <div class="stat-label">Total Value</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${formatCurrency(stats.pending_amount)}</div>
            <div class="stat-label">Pending Amount</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${formatCurrency(stats.paid_amount)}</div>
            <div class="stat-label">Paid Amount</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${formatCurrency(stats.defaulted_amount)}</div>
            <div class="stat-label">Defaulted Amount</div>
        </div>
    `;
}

// Update purchaser statistics
function updatePurchaserStats(stats) {
    const statsGrid = document.getElementById('purchaserStats');
    statsGrid.innerHTML = `
        <div class="stat-card">
            <div class="stat-value">${stats.total_invoices}</div>
            <div class="stat-label">Invoices Received</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${formatCurrency(stats.total_amount)}</div>
            <div class="stat-label">Total Owed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${formatCurrency(stats.pending_amount)}</div>
            <div class="stat-label">Pending Amount</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${formatCurrency(stats.paid_amount)}</div>
            <div class="stat-label">Paid Amount</div>
        </div>
    `;
}

// Display provider invoices
function displayProviderInvoices(invoices) {
    const tbody = document.getElementById('providerInvoicesBody');
    tbody.innerHTML = invoices.map(invoice => `
        <tr>
            <td>${invoice.invoice_number}</td>
            <td>${invoice.purchaser_company}</td>
            <td>${new Date(invoice.issue_date).toLocaleDateString()}</td>
            <td>${formatCurrency(invoice.total_amount)}</td>
            <td>${invoice.currency}</td>
            <td><span class="status-${invoice.status}">${invoice.status.toUpperCase()}</span></td>
            <td>
                <button class="btn btn-primary" onclick="viewInvoice(${invoice.id})">View</button>
            </td>
        </tr>
    `).join('');
}

// Display purchaser invoices
function displayPurchaserInvoices(invoices) {
    const tbody = document.getElementById('purchaserInvoicesBody');
    tbody.innerHTML = invoices.map(invoice => `
        <tr>
            <td>${invoice.invoice_number}</td>
            <td>${invoice.provider_company}</td>
            <td>${new Date(invoice.issue_date).toLocaleDateString()}</td>
            <td>${new Date(invoice.due_date).toLocaleDateString()}</td>
            <td>${formatCurrency(invoice.total_amount)}</td>
            <td>${invoice.currency}</td>
            <td><span class="status-${invoice.status}">${invoice.status.toUpperCase()}</span></td>
            <td>
                ${invoice.status === 'pending' ? `
                    <button class="btn btn-success" onclick="recordPayment(${invoice.id})">Pay</button>
                    <button class="btn btn-danger" onclick="markDefaulted(${invoice.id})">Default</button>
                ` : `
                    <button class="btn btn-primary" onclick="viewInvoice(${invoice.id})">View</button>
                `}
            </td>
        </tr>
    `).join('');
}

// Format currency
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(amount || 0);
}

// Show create invoice modal
async function showCreateInvoiceModal() {
    // Load purchasers for dropdown
    try {
        const response = await fetch('/api/users/purchasers', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const purchasers = await response.json();
        
        const select = document.getElementById('invoicePurchaser');
        select.innerHTML = purchasers.map(p => 
            `<option value="${p.id}">${p.company_name}</option>`
        ).join('');
    } catch (error) {
        console.error('Failed to load purchasers:', error);
    }
    
    document.getElementById('createInvoiceModal').style.display = 'block';
}

// Show create invoice modal
/*async function showCreateInvoiceModal() {
    // Load purchasers for dropdown
    try {
        const response = await fetch('/api/users/purchasers', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load purchasers');
        }
        
        const purchasers = await response.json();
        
        const select = document.getElementById('invoicePurchaser');
        select.innerHTML = '<option value="">Select a purchaser...</option>' + 
            purchasers.map(p => `<option value="${p.id}">${p.company_name}</option>`).join('');
        
        // Set default due date to 30 days from now
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 30);
        document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];
        
    } catch (error) {
        console.error('Failed to load purchasers:', error);
        alert('Failed to load purchaser list. Please try again.');
        return;
    }
    
    document.getElementById('createInvoiceModal').style.display = 'block';
}*/







// Add invoice item
function addInvoiceItem() {
    const itemsContainer = document.getElementById('invoiceItems');
    const newItem = document.createElement('div');
    newItem.className = 'invoice-item';
    newItem.innerHTML = `
        <div class="form-group">
            <label>Item Description:</label>
            <input type="text" class="item-description" required>
        </div>
        <div class="form-group">
            <label>Quantity:</label>
            <input type="number" class="item-quantity" required>
        </div>
        <div class="form-group">
            <label>Unit Price:</label>
            <input type="number" class="item-price" step="0.01" required>
        </div>
        <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">Remove</button>
    `;
    itemsContainer.appendChild(newItem);
}

// Create invoice form
document.getElementById('createInvoiceForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const purchaserId = document.getElementById('invoicePurchaser').value;
    const currency = document.getElementById('invoiceCurrency').value;
    const dueDate = document.getElementById('invoiceDueDate').value;
    
    const items = [];
    document.querySelectorAll('.invoice-item').forEach(item => {
        const description = item.querySelector('.item-description').value;
        const quantity = parseInt(item.querySelector('.item-quantity').value);
        const unitPrice = parseFloat(item.querySelector('.item-price').value);
        
        items.push({ description, quantity, unit_price: unitPrice });
    });
    
    try {
        const response = await fetch('/api/invoices', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                purchaser_id: purchaserId,
                currency: currency,
                due_date: dueDate,
                items: items
            })
        });

        if (response.ok) {
            alert('Invoice created successfully!');
            document.getElementById('createInvoiceModal').style.display = 'none';
            loadProviderData();
        } else {
            const data = await response.json();
            alert('Failed to create invoice: ' + data.error);
        }
    } catch (error) {
        alert('Failed to create invoice: ' + error.message);
    }


    
});




// Record payment
/*async function recordPayment(invoiceId) {
    const amount = prompt('Enter payment amount:');
    if (!amount) return;
    
    try {
        const response = await fetch(`/api/invoices/${invoiceId}/payments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                amount: parseFloat(amount),
                payment_date: new Date().toISOString().split('T')[0],
                payment_method: 'Bank Transfer'
            })
        });

        if (response.ok) {
            alert('Payment recorded successfully!');
            loadPurchaserData();
        } else {
            const data = await response.json();
            alert('Failed to record payment: ' + data.error);
        }
    } catch (error) {
        alert('Failed to record payment: ' + error.message);
    }
}*/

// Debug function to check payments
async function debugPayments() {
    try {
        const response = await fetch('/api/payments', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        console.log('Payments response:', response.status, await response.json());
    } catch (error) {
        console.error('Payments debug error:', error);
    }
}



// Show payment modal
async function recordPayment(invoiceId) {
    // Get invoice details to show remaining amount
    try {
        const response = await fetch(`/api/invoices/${invoiceId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const invoice = await response.json();
            
            // Set today's date as default
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            
            // Store invoice ID for the form
            document.getElementById('paymentInvoiceId').value = invoiceId;
            
            // Show invoice info in modal title
            document.querySelector('#paymentModal h3').textContent = 
                `Record Payment - ${invoice.invoice_number}`;
            
            document.getElementById('paymentModal').style.display = 'block';
        }
    } catch (error) {
        console.error('Failed to load invoice details:', error);
        // Still show modal even if invoice details fail
        document.getElementById('paymentInvoiceId').value = invoiceId;
        document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('paymentModal').style.display = 'block';
    }
}








// Handle payment form submission
/*document.getElementById('paymentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const invoiceId = document.getElementById('paymentInvoiceId').value;
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const paymentDate = document.getElementById('paymentDate').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const referenceNumber = document.getElementById('paymentReference').value;
    
    try {
        const response = await fetch(`/api/invoices/${invoiceId}/payments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                amount: amount,
                payment_date: paymentDate,
                payment_method: paymentMethod,
                reference_number: referenceNumber
            })
        });

        if (response.ok) {
            alert('Payment recorded successfully!');
            document.getElementById('paymentModal').style.display = 'none';
            document.getElementById('paymentForm').reset();
            loadPurchaserData(); // Refresh the data
        } else {
            const data = await response.json();
            alert('Failed to record payment: ' + data.error);
        }
    } catch (error) {
        alert('Failed to record payment: ' + error.message);
    }
});
*/


// Handle payment form submission
/*document.getElementById('paymentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const invoiceId = document.getElementById('paymentInvoiceId').value;
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const paymentDate = document.getElementById('paymentDate').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const referenceNumber = document.getElementById('paymentReference').value;
    
    try {
        const response = await fetch(`/api/invoices/${invoiceId}/payments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                amount: amount,
                payment_date: paymentDate,
                payment_method: paymentMethod,
                reference_number: referenceNumber
            })
        });

        if (response.ok) {
            alert('Payment recorded successfully!');
            document.getElementById('paymentModal').style.display = 'none';
            document.getElementById('paymentForm').reset();
            
            // Force refresh all data
            if (currentUser.role === 'purchaser') {
                await loadPurchaserData();
                
                // Switch to payments tab to see the new payment
                showTab('payments');
            }
        } else {
            const data = await response.json();
            alert('Failed to record payment: ' + data.error);
        }
    } catch (error) {
        alert('Failed to record payment: ' + error.message);
    }
});*/

// Handle payment form submission
document.getElementById('paymentForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const invoiceId = document.getElementById('paymentInvoiceId').value;
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const paymentDate = document.getElementById('paymentDate').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const referenceNumber = document.getElementById('paymentReference').value;
    
    try {
        const response = await fetch(`/api/invoices/${invoiceId}/payments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                amount: amount,
                payment_date: paymentDate,
                payment_method: paymentMethod,
                reference_number: referenceNumber
            })
        });

        if (response.ok) {
            alert('Payment recorded successfully!');
            document.getElementById('paymentModal').style.display = 'none';
            document.getElementById('paymentForm').reset();
            
            // Force refresh all data
            if (currentUser.role === 'purchaser') {
                await loadPurchaserData();
                
                // Switch to payments section to see the new payment
                showSection('payments');
            }
        } else {
            const data = await response.json();
            alert('Failed to record payment: ' + data.error);
        }
    } catch (error) {
        alert('Failed to record payment: ' + error.message);
    }
});





// Mark invoice as defaulted
async function markDefaulted(invoiceId) {
    if (!confirm('Are you sure you want to mark this invoice as defaulted?')) return;
    
    try {
        const response = await fetch(`/api/invoices/${invoiceId}/default`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
    //method: 'POST'


        if (response.ok) {
            alert('Invoice marked as defaulted!');
            loadPurchaserData();
        } else {
            const data = await response.json();
            alert('Failed to mark as defaulted: ' + data.error);
        }
    } catch (error) {
        alert('Failed to mark as defaulted: ' + error.message);
    }
}

// View invoice details
//function viewInvoice(invoiceId) {
    //alert(`Viewing invoice ${invoiceId} - Details would show here in a real implementation`);
//}


// View invoice details
/*async function viewInvoice(invoiceId) {
    try {
        const response = await fetch(`/api/invoices/${invoiceId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            const invoice = await response.json();
            showInvoiceDetails(invoice);
        } else {
            alert('Failed to load invoice details');
        }
    } catch (error) {
        alert('Failed to load invoice details: ' + error.message);
    }
}*/



// View invoice details
async function viewInvoice(invoiceId) {
    try {
        const response = await fetch(`/api/invoices/${invoiceId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();
        
        if (response.ok) {
            showInvoiceDetails(data);
        } else {
            alert('Failed to load invoice details: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error loading invoice:', error);
        alert('Failed to load invoice details: ' + error.message);
    }
}

// Show invoice details in a modal
function showInvoiceDetails(invoice) {
    const itemsHtml = invoice.items.map(item => `
        <tr>
            <td>${item.description}</td>
            <td>${item.quantity}</td>
            <td>${formatCurrency(item.unit_price)}</td>
            <td>${formatCurrency(item.line_total)}</td>
        </tr>
    `).join('');

    const modalHtml = `
        <div class="modal" style="display: block;">
            <div class="modal-content" style="max-width: 700px;">
                <h3>Invoice Details - ${invoice.invoice_number}</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <strong>Provider:</strong> ${invoice.provider_company || currentUser.company_name}<br>
                        <strong>Purchaser:</strong> ${invoice.purchaser_company || currentUser.company_name}<br>
                        <strong>Issue Date:</strong> ${new Date(invoice.issue_date).toLocaleDateString()}
                    </div>
                    <div>
                        <strong>Due Date:</strong> ${new Date(invoice.due_date).toLocaleDateString()}<br>
                        <strong>Currency:</strong> ${invoice.currency}<br>
                        <strong>Status:</strong> <span class="status-${invoice.status}">${invoice.status.toUpperCase()}</span>
                    </div>
                </div>
                
                <h4>Items</h4>
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="text-align: right; font-weight: bold;">Grand Total:</td>
                            <td style="font-weight: bold;">${formatCurrency(invoice.total_amount)}</td>
                        </tr>
                    </tfoot>
                </table>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn" onclick="this.closest('.modal').style.display='none'">Close</button>
                </div>
            </div>
        </div>
    `;
    
    // Create and show modal
    const modal = document.createElement('div');
    modal.innerHTML = modalHtml;
    document.body.appendChild(modal);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });
}







// Tab navigation
/*function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('[id$="Tab"]').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // Show selected tab
    document.getElementById(tabName + 'Tab').style.display = 'block';
    
    // Update active nav
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.classList.add('active');
}*/

// Tab navigation
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('[id$="Tab"]').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // Show selected tab
    document.getElementById(tabName + 'Tab').style.display = 'block';
    
    // Update active nav
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Activate the correct nav item
    document.querySelectorAll('.nav-item').forEach(item => {
        if (item.textContent.trim().toLowerCase().includes(tabName.toLowerCase())) {
            item.classList.add('active');
        }
    });
    
    // Load analytics when analytics tab is clicked
    if (tabName === 'analytics' && currentUser.role === 'provider') {
        loadAnalytics();
    }
}

// Load analytics data
/*async function loadAnalytics() {
    try {
        const response = await fetch('/api/analytics', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            const analytics = await response.json();
            renderAnalyticsCharts(analytics);
        } else {
            console.error('Failed to load analytics');
        }
    } catch (error) {
        console.error('Error loading analytics:', error);
    }
}*/


// Load analytics data
/*async function loadAnalytics() {
    try {
        // Show loading
        document.getElementById('analyticsLoading').style.display = 'block';
        
        const response = await fetch('/api/analytics', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            const analytics = await response.json();
            renderAnalyticsCharts(analytics);
        } else {
            document.getElementById('analyticsLoading').innerHTML = '<p>Failed to load analytics data.</p>';
        }
    } catch (error) {
        console.error('Error loading analytics:', error);
        document.getElementById('analyticsLoading').innerHTML = '<p>Error loading analytics data.</p>';
    }
}*/

// Load analytics data
/*async function loadAnalytics() {
    try {
        // Show loading
        document.getElementById('analyticsLoading').style.display = 'block';
        document.getElementById('analyticsLoading').innerHTML = '<p>Loading analytics data...</p>';
        
        const response = await fetch('/api/analytics', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            const analytics = await response.json();
            renderAnalyticsCharts(analytics);
        } else {
            const errorData = await response.json();
            document.getElementById('analyticsLoading').innerHTML = 
                `<p>Failed to load analytics: ${errorData.error || 'Unknown error'}</p>`;
        }
    } catch (error) {
        console.error('Error loading analytics:', error);
        document.getElementById('analyticsLoading').innerHTML = 
            `<p>Network error: ${error.message}</p>`;
    }
}*/
// Load analytics data
/*async function loadAnalytics() {
    try {
        // Show loading
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
            analyticsContent.innerHTML = '<div style="text-align: center; padding: 40px;">Loading analytics data...</div>';
        }
        
        const response = await fetch('/api/analytics', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            const analytics = await response.json();
            renderAnalyticsCharts(analytics);
        } else {
            const errorData = await response.json();
            document.getElementById('analyticsContent').innerHTML = 
                `<div style="text-align: center; padding: 40px; color: #dc3545;">Failed to load analytics: ${errorData.error || 'Unknown error'}</div>`;
        }
    } catch (error) {
        console.error('Error loading analytics:', error);
        document.getElementById('analyticsContent').innerHTML = 
            `<div style="text-align: center; padding: 40px; color: #dc3545;">Network error: ${error.message}</div>`;
    }
}*/

// Load analytics data
async function loadAnalytics() {
    try {
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
            analyticsContent.innerHTML = '<div style="text-align: center; padding: 40px;">Loading analytics data...</div>';
        }
        
        const response = await fetch('/api/analytics', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            const analytics = await response.json();
            renderAnalyticsCharts(analytics);
        } else {
            const errorData = await response.json();
            if (analyticsContent) {
                analyticsContent.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc3545;">Failed to load analytics: ${errorData.error || 'Unknown error'}</div>`;
            }
        }
    } catch (error) {
        console.error('Error loading analytics:', error);
        const analyticsContent = document.getElementById('analyticsContent');
        if (analyticsContent) {
            analyticsContent.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc3545;">Network error: ${error.message}</div>`;
        }
    }
}

// Render analytics charts
/*function renderAnalyticsCharts(analytics) {
    const ctx = document.getElementById('providerChart').getContext('2d');
    
    // Clear previous charts
    if (window.analyticsCharts) {
        Object.values(window.analyticsCharts).forEach(chart => chart.destroy());
    }
    window.analyticsCharts = {};
    
    // Chart 1: Invoice Status Distribution (Pie Chart)
    const statusCtx = document.createElement('canvas');
    statusCtx.width = 400;
    statusCtx.height = 300;
    document.getElementById('analyticsTab').appendChild(statusCtx);
    
    const statusLabels = analytics.statusDistribution.map(item => 
        item.status.charAt(0).toUpperCase() + item.status.slice(1)
    );
    const statusData = analytics.statusDistribution.map(item => item.count);
    const statusColors = ['#28a745', '#ffc107', '#dc3545']; // Green, Yellow, Red
    
    window.analyticsCharts.statusChart = new Chart(statusCtx, {
        type: 'pie',
        data: {
            labels: statusLabels,
            datasets: [{
                data: statusData,
                backgroundColor: statusColors,
                borderWidth: 2
            }]
        },
        options: {
            responsive: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Invoice Status Distribution'
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Chart 2: Monthly Revenue (Line Chart)
    const revenueCtx = document.createElement('canvas');
    revenueCtx.width = 600;
    revenueCtx.height = 300;
    document.getElementById('analyticsTab').appendChild(revenueCtx);
    
    const months = analytics.monthlyRevenue.map(item => {
        const [year, month] = item.month.split('-');
        return new Date(year, month - 1).toLocaleDateString('en', { month: 'short', year: 'numeric' });
    });
    const revenue = analytics.monthlyRevenue.map(item => item.revenue);
    
    window.analyticsCharts.revenueChart = new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Monthly Revenue',
                data: revenue,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderWidth: 2,
                fill: true
            }]
        },
        options: {
            responsive: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Monthly Revenue (Last 12 Months)'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Chart 3: Top Purchasers (Bar Chart)
    const purchasersCtx = document.createElement('canvas');
    purchasersCtx.width = 600;
    purchasersCtx.height = 300;
    document.getElementById('analyticsTab').appendChild(purchasersCtx);
    
    const purchaserNames = analytics.topPurchasers.map(item => item.company_name);
    const purchaserAmounts = analytics.topPurchasers.map(item => item.total_amount);
    
    window.analyticsCharts.purchasersChart = new Chart(purchasersCtx, {
        type: 'bar',
        data: {
            labels: purchaserNames,
            datasets: [{
                label: 'Total Invoice Amount',
                data: purchaserAmounts,
                backgroundColor: '#17a2b8',
                borderColor: '#138496',
                borderWidth: 1
            }]
        },
        options: {
            responsive: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Top 5 Purchasers by Revenue'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}*/

// Render analytics charts
/*function renderAnalyticsCharts(analytics) {
    const analyticsTab = document.getElementById('analyticsTab');
    
    // Clear previous charts and hide loading
    document.getElementById('analyticsLoading').style.display = 'none';
    
    // Clear previous charts
    if (window.analyticsCharts) {
        Object.values(window.analyticsCharts).forEach(chart => chart.destroy());
    }
    
    // Remove existing chart containers
    const existingCharts = analyticsTab.querySelectorAll('.chart-container');
    existingCharts.forEach(chart => chart.remove());
    
    window.analyticsCharts = {};
    
    // Create container for charts
    const chartsContainer = analyticsTab.querySelector('div[style*="display: flex"]');
    
    if (analytics.statusDistribution && analytics.statusDistribution.length > 0) {
        // Chart 1: Invoice Status Distribution (Pie Chart)
        const statusContainer = document.createElement('div');
        statusContainer.className = 'chart-container';
        statusContainer.style.cssText = 'background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
        
        const statusTitle = document.createElement('h4');
        statusTitle.textContent = 'Invoice Status Distribution';
        statusTitle.style.textAlign = 'center';
        statusTitle.style.marginBottom = '20px';
        statusContainer.appendChild(statusTitle);
        
        const statusCanvas = document.createElement('canvas');
        statusCanvas.width = 300;
        statusCanvas.height = 300;
        statusContainer.appendChild(statusCanvas);
        chartsContainer.appendChild(statusContainer);
        
        const statusLabels = analytics.statusDistribution.map(item => 
            item.status.charAt(0).toUpperCase() + item.status.slice(1)
        );
        const statusData = analytics.statusDistribution.map(item => item.count);
        const statusColors = ['#28a745', '#ffc107', '#dc3545'];
        
        window.analyticsCharts.statusChart = new Chart(statusCanvas, {
            type: 'pie',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusData,
                    backgroundColor: statusColors,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    if (analytics.monthlyRevenue && analytics.monthlyRevenue.length > 0) {
        // Chart 2: Monthly Revenue (Line Chart)
        const revenueContainer = document.createElement('div');
        revenueContainer.className = 'chart-container';
        revenueContainer.style.cssText = 'background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 100%; max-width: 800px;';
        
        const revenueTitle = document.createElement('h4');
        revenueTitle.textContent = 'Monthly Revenue (Last 12 Months)';
        revenueTitle.style.textAlign = 'center';
        revenueTitle.style.marginBottom = '20px';
        revenueContainer.appendChild(revenueTitle);
        
        const revenueCanvas = document.createElement('canvas');
        revenueCanvas.width = 700;
        revenueCanvas.height = 300;
        revenueContainer.appendChild(revenueCanvas);
        chartsContainer.appendChild(revenueContainer);
        
        const months = analytics.monthlyRevenue.map(item => {
            const [year, month] = item.month.split('-');
            return new Date(year, month - 1).toLocaleDateString('en', { month: 'short', year: 'numeric' });
        });
        const revenue = analytics.monthlyRevenue.map(item => item.revenue);
        
        window.analyticsCharts.revenueChart = new Chart(revenueCanvas, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Monthly Revenue',
                    data: revenue,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 2,
                    fill: true
                }]
            },
            options: {
                responsive: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    if (analytics.topPurchasers && analytics.topPurchasers.length > 0) {
        // Chart 3: Top Purchasers (Bar Chart)
        const purchasersContainer = document.createElement('div');
        purchasersContainer.className = 'chart-container';
        purchasersContainer.style.cssText = 'background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 100%; max-width: 800px;';
        
        const purchasersTitle = document.createElement('h4');
        purchasersTitle.textContent = 'Top 5 Purchasers by Revenue';
        purchasersTitle.style.textAlign = 'center';
        purchasersTitle.style.marginBottom = '20px';
        purchasersContainer.appendChild(purchasersTitle);
        
        const purchasersCanvas = document.createElement('canvas');
        purchasersCanvas.width = 700;
        purchasersCanvas.height = 300;
        purchasersContainer.appendChild(purchasersCanvas);
        chartsContainer.appendChild(purchasersContainer);
        
        const purchaserNames = analytics.topPurchasers.map(item => item.company_name);
        const purchaserAmounts = analytics.topPurchasers.map(item => item.total_amount);
        
        window.analyticsCharts.purchasersChart = new Chart(purchasersCanvas, {
            type: 'bar',
            data: {
                labels: purchaserNames,
                datasets: [{
                    label: 'Total Invoice Amount',
                    data: purchaserAmounts,
                    backgroundColor: '#17a2b8',
                    borderColor: '#138496',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Show message if no data
    if ((!analytics.statusDistribution || analytics.statusDistribution.length === 0) &&
        (!analytics.monthlyRevenue || analytics.monthlyRevenue.length === 0) &&
        (!analytics.topPurchasers || analytics.topPurchasers.length === 0)) {
        document.getElementById('analyticsLoading').innerHTML = '<p>No analytics data available yet. Create some invoices to see analytics.</p>';
        document.getElementById('analyticsLoading').style.display = 'block';
    }
}*/
// Render analytics charts
function renderAnalyticsCharts(analytics) {
    const analyticsContent = document.getElementById('analyticsContent');
    if (!analyticsContent) return;
    
    // Clear previous content
    analyticsContent.innerHTML = '';
    
    // Clear previous charts
    if (window.analyticsCharts) {
        Object.values(window.analyticsCharts).forEach(chart => chart.destroy());
    }
    window.analyticsCharts = {};
    
    // Create charts container
    const chartsContainer = document.createElement('div');
    chartsContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;';
    analyticsContent.appendChild(chartsContainer);
    
    if (analytics.statusDistribution && analytics.statusDistribution.length > 0) {
        // Chart 1: Invoice Status Distribution (Pie Chart)
        const statusContainer = document.createElement('div');
        statusContainer.style.cssText = 'background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
        
        const statusTitle = document.createElement('h4');
        statusTitle.textContent = 'Invoice Status Distribution';
        statusTitle.style.textAlign = 'center';
        statusTitle.style.marginBottom = '20px';
        statusContainer.appendChild(statusTitle);
        
        const statusCanvas = document.createElement('canvas');
        statusCanvas.width = 300;
        statusCanvas.height = 300;
        statusContainer.appendChild(statusCanvas);
        chartsContainer.appendChild(statusContainer);
        
        const statusLabels = analytics.statusDistribution.map(item => 
            item.status.charAt(0).toUpperCase() + item.status.slice(1)
        );
        const statusData = analytics.statusDistribution.map(item => item.count);
        const statusColors = ['#28a745', '#ffc107', '#dc3545'];
        
        window.analyticsCharts.statusChart = new Chart(statusCanvas, {
            type: 'pie',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusData,
                    backgroundColor: statusColors,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    if (analytics.monthlyRevenue && analytics.monthlyRevenue.length > 0) {
        // Chart 2: Monthly Revenue (Line Chart)
        const revenueContainer = document.createElement('div');
        revenueContainer.style.cssText = 'background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 100%; max-width: 800px;';
        
        const revenueTitle = document.createElement('h4');
        revenueTitle.textContent = 'Monthly Revenue (Last 12 Months)';
        revenueTitle.style.textAlign = 'center';
        revenueTitle.style.marginBottom = '20px';
        revenueContainer.appendChild(revenueTitle);
        
        const revenueCanvas = document.createElement('canvas');
        revenueCanvas.width = 700;
        revenueCanvas.height = 300;
        revenueContainer.appendChild(revenueCanvas);
        chartsContainer.appendChild(revenueContainer);
        
        const months = analytics.monthlyRevenue.map(item => {
            const [year, month] = item.month.split('-');
            return new Date(year, month - 1).toLocaleDateString('en', { month: 'short', year: 'numeric' });
        });
        const revenue = analytics.monthlyRevenue.map(item => item.revenue);
        
        window.analyticsCharts.revenueChart = new Chart(revenueCanvas, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Monthly Revenue',
                    data: revenue,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 2,
                    fill: true
                }]
            },
            options: {
                responsive: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    if (analytics.topPurchasers && analytics.topPurchasers.length > 0) {
        // Chart 3: Top Purchasers (Bar Chart)
        const purchasersContainer = document.createElement('div');
        purchasersContainer.style.cssText = 'background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 100%; max-width: 800px;';
        
        const purchasersTitle = document.createElement('h4');
        purchasersTitle.textContent = 'Top 5 Purchasers by Revenue';
        purchasersTitle.style.textAlign = 'center';
        purchasersTitle.style.marginBottom = '20px';
        purchasersContainer.appendChild(purchasersTitle);
        
        const purchasersCanvas = document.createElement('canvas');
        purchasersCanvas.width = 700;
        purchasersCanvas.height = 300;
        purchasersContainer.appendChild(purchasersCanvas);
        chartsContainer.appendChild(purchasersContainer);
        
        const purchaserNames = analytics.topPurchasers.map(item => item.company_name);
        const purchaserAmounts = analytics.topPurchasers.map(item => item.total_amount);
        
        window.analyticsCharts.purchasersChart = new Chart(purchasersCanvas, {
            type: 'bar',
            data: {
                labels: purchaserNames,
                datasets: [{
                    label: 'Total Invoice Amount',
                    data: purchaserAmounts,
                    backgroundColor: '#17a2b8',
                    borderColor: '#138496',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Show message if no data
    if ((!analytics.statusDistribution || analytics.statusDistribution.length === 0) &&
        (!analytics.monthlyRevenue || analytics.monthlyRevenue.length === 0) &&
        (!analytics.topPurchasers || analytics.topPurchasers.length === 0)) {
        analyticsContent.innerHTML = '<div style="text-align: center; padding: 40px;"><p>No analytics data available yet. Create some invoices to see analytics.</p></div>';
    }
}
//TEMPORARYYYYYYY
// Test payments function - add this temporarily
/*async function testPayments() {
    try {
        console.log('Testing payments...');
        
        // Test 1: Check if API endpoint works
        const response = await fetch('/api/payments', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        console.log('Payments API status:', response.status);
        
        if (response.ok) {
            const payments = await response.json();
            console.log('Payments data:', payments);
            console.log('Number of payments:', payments.length);
            
            // Test 2: Check if table body exists
            const tbody = document.getElementById('paymentsBody');
            console.log('Payments table body found:', !!tbody);
            
            if (tbody) {
                console.log('Table body innerHTML before:', tbody.innerHTML);
            }
        } else {
            console.log('Payments API error:', await response.json());
        }
    } catch (error) {
        console.error('Payments test error:', error);
    }
}*/
// Enhanced test payments function
async function testPayments() {
    try {
        console.log('=== TESTING PAYMENTS ===');
        
        // Test 1: Check DOM element
        const tbody = document.getElementById('paymentsBody');
        console.log('1. Payments table body found:', !!tbody);
        
        // Test 2: Check API endpoint
        console.log('2. Testing API endpoint...');
        const response = await fetch('/api/payments', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        console.log('   API Status:', response.status);
        
        if (response.ok) {
            const payments = await response.json();
            console.log('   Payments data:', payments);
            console.log('   Number of payments:', payments.length);
            
            // Test 3: Manual display
            console.log('3. Manually displaying payments...');
            displayPayments(payments);
            
            // Test 4: Verify display
            console.log('4. Table content after display:');
            console.log('   Rows in table:', tbody.querySelectorAll('tr').length);
            
        } else {
            const error = await response.json();
            console.log('   API Error:', error);
        }
        
        console.log('=== TEST COMPLETE ===');
    } catch (error) {
        console.error('Payments test error:', error);
    }
}






// Logout
function logout() {
    localStorage.removeItem('token');
    currentUser = null;
    token = null;
    
    providerDashboard.style.display = 'none';
    purchaserDashboard.style.display = 'none';
    authSection.style.display = 'block';
}
    </script>
    <!-- Payment Modal -->
<div id="paymentModal" class="modal payment-modal">
    <div class="modal-content">
        <h3>Record Payment</h3>
        <form id="paymentForm">
            <input type="hidden" id="paymentInvoiceId">
            <div class="form-group">
                <label>Amount:</label>
                <input type="number" id="paymentAmount" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Payment Date:</label>
                <input type="date" id="paymentDate" required>
            </div>
            <div class="form-group">
                <label>Payment Method:</label>
                <select id="paymentMethod" required>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="Cash">Cash</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="Mobile Money">Mobile Money</option>
                    <option value="Check">Check</option>
                </select>
            </div>
            <div class="form-group">
                <label>Reference Number (Optional):</label>
                <input type="text" id="paymentReference">
            </div>
            <button type="submit" class="btn btn-success">Record Payment</button>
            <button type="button" class="btn" onclick="document.getElementById('paymentModal').style.display='none'">Cancel</button>
        </form>
    </div>
</div>
</body>
</html>